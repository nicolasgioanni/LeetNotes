name: Update Study Notes

on:
  schedule:
    - cron: "0 13 * * 1-4,6"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      PYTHONPATH: src
      SHEET_CSV_URL: ${{ secrets.SHEET_CSV_URL }}
      SOLUTIONS_CSV_URL: ${{ secrets.SOLUTIONS_CSV_URL }}
      SHEET_CSV_URL_NEETCODE150: ${{ secrets.SHEET_CSV_URL_NEETCODE150 }}
      SOLUTIONS_CSV_URL_NEETCODE150: ${{ secrets.SOLUTIONS_CSV_URL_NEETCODE150 }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Verify CSV endpoints
        run: |
          python - <<'PY'
          import os
          import sys
          import urllib.request

          CONNECT_TIMEOUT = 10
          READ_TIMEOUT = 120


          def set_read_timeout(response, timeout: float) -> None:
              try:
                  fp = getattr(response, "fp", None)
                  raw = getattr(fp, "raw", None)
                  sock = getattr(raw, "_sock", None)
                  if sock:
                      sock.settimeout(timeout)
              except Exception:
                  pass


          checks = [
              ("SHEET_CSV_URL", os.environ.get("SHEET_CSV_URL"), "Blind 75 notes", False),
              ("SOLUTIONS_CSV_URL", os.environ.get("SOLUTIONS_CSV_URL"), "Blind 75 solutions", False),
              ("SHEET_CSV_URL_NEETCODE150", os.environ.get("SHEET_CSV_URL_NEETCODE150"), "NeetCode 150 notes", False),
              ("SOLUTIONS_CSV_URL_NEETCODE150", os.environ.get("SOLUTIONS_CSV_URL_NEETCODE150"), "NeetCode 150 solutions", True),
          ]

          failures: list[str] = []
          for env_var, url, label, optional in checks:
              if not url:
                  message = f"{label}: missing {env_var}"
                  if optional:
                      print(f"Skipping {message}")
                      continue
                  failures.append(message)
                  continue
              try:
                  with urllib.request.urlopen(url, timeout=CONNECT_TIMEOUT) as response:  # type: ignore[arg-type]
                      status = getattr(response, "status", None)
                      if status not in (200, None):
                          raise RuntimeError(f"HTTP status {status}")
                      set_read_timeout(response, READ_TIMEOUT)
                      response.read(1024)
                  print(f"{label}: OK")
              except Exception as exc:
                  failures.append(f"{label} ({env_var}) failed: {exc}")

          if failures:
              print("CSV preflight failed:")
              for failure in failures:
                  print(f" - {failure}")
              sys.exit(1)
          PY

      - name: Sync solutions from spreadsheet
        env:
          SOLUTIONS_CSV_URL: ${{ secrets.SOLUTIONS_CSV_URL }}
        run: python -m leetnotes.cli --solutions-only

      - name: Regenerate Blind 75 notes
        run: python -m leetnotes.cli

      - name: Regenerate NeetCode 150 notes
        env:
          SHEET_CSV_URL_NEETCODE150: ${{ secrets.SHEET_CSV_URL_NEETCODE150 }}
        run: python -m leetnotes.cli --profile neetcode150

      - name: Upload cached CSVs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: csv-files
          path: "CSV Files"
          if-no-files-found: ignore

      - name: Commit and push if changed
        run: |
          git add -f "Notes/blind75.md" "Notes/neetcode150.md" "Problems" "Problems/README.md"
          if [ -d "CSV Files" ]; then
            git add -f "CSV Files"
          fi
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git config --global user.name "${{ secrets.COMMIT_USER_NAME }}"
            git config --global user.email "${{ secrets.COMMIT_USER_EMAIL }}"
            git commit -m "Update study notes"
            git push
          fi
